<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>펀치머신 점수 입력</title>
<style>
  :root{--bg:#0b1023;--card:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--border:#233052;--accent:#22d3ee}
  *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR','Malgun Gothic',sans-serif}
  body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:grid;place-items:center}
  .wrap{width:100%;max-width:520px;padding:20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 12px;font-size:22px;letter-spacing:-.02em}
  label{display:block;font-size:13px;color:#cbd5e1;margin:8px 0 6px}
  input{width:100%;background:#0b1021;border:1px solid var(--border);border-radius:12px;padding:14px;color:var(--text);font-size:18px}
  input:focus{outline:none;box-shadow:0 0 0 4px rgba(34,211,238,.12);border-color:var(--accent)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  button{width:100%;margin-top:14px;padding:14px;border-radius:12px;border:1px solid #1fbdd1;background:linear-gradient(180deg,#11a0b4,#0f8ea6);color:#001018;font-weight:800;font-size:18px;cursor:pointer}
  .muted{color:var(--muted);font-size:12px;margin-top:8px}
  .ok{color:#34d399}.err{color:#f87171}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>펀치머신 점수 입력</h1>
    <form id="scoreForm" autocomplete="off">
      <label for="name">이름</label>
      <input id="name" name="name" placeholder="예: 김펀치" autocomplete="name" required>

      <div class="row">
        <div>
          <label for="phone">전화번호(끝 4자리만 공개)</label>
          <input id="phone" name="phone" inputmode="numeric" pattern="[0-9\- ]{8,}" placeholder="예: 01012345678" required>
        </div>
        <div>
          <label for="score">점수</label>
          <input id="score" name="score" type="number" inputmode="numeric" min="0" max="999999" placeholder="0" required>
        </div>
      </div>

      <label for="pin">진행요원 PIN</label>
      <input id="pin" name="pin" inputmode="numeric" placeholder="현장 전용" required>

      <button type="submit">전송</button>
      <div id="msg" class="muted">전화번호는 **끝 4자리만 저장**됩니다.</div>
    </form>
  </div>
</div>

<script>
  // 당신이 제공한 GAS 최신 배포 URL (/exec)
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbza1QVoob_QeyfWaB8NjaYHaSys7YRkNvoqVlbmkPGonch_ajcaxSYb2odRiR3IZs_x/exec';

  const $ = s => document.querySelector(s);
  const onlyDigits = s => (s||'').replace(/\D/g,'');

  // 편의: 이름/PIN 로컬 저장
  const LS = { name:'punch_name_v1', pin:'punch_pin_v1' };
  window.addEventListener('DOMContentLoaded', ()=>{
    $('#name').value = localStorage.getItem(LS.name) || '';
    $('#pin').value  = localStorage.getItem(LS.pin)  || '';
    $('#name').focus();
  });

  // 헤더 없이 urlencoded로 보내 프리플라이트(OPTIONS) 회피
  async function sendForm(data){
    const body = new URLSearchParams(data);
    const res = await fetch(GAS_URL, { method:'POST', body }); // 헤더 넣지 않기!
    // Apps Script는 200만 반환하므로, 본문 파싱 없이도 성공 처리 가능
    if(!res.ok) throw new Error('서버 응답 오류 ' + res.status);
    return true;
  }

  function readForm(f){
    const name  = f.name.value.trim() || '익명';
    const phone = onlyDigits(f.phone.value.trim());
    const score = Math.max(0, Math.floor(Number(f.score.value||0)));
    const pin   = f.pin.value.trim();
    return { name, phone, score, pin };
  }

  $('#scoreForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const f = e.target;
    const msg = $('#msg');

    try{
      const p = readForm(f);
      if(p.phone.length < 8) throw new Error('전화번호를 확인하세요');
      if(!(p.score>=0))     throw new Error('점수가 올바르지 않습니다');

      msg.textContent = '전송 중…';
      await sendForm(p);

      // 편의 저장
      localStorage.setItem(LS.name, p.name);
      localStorage.setItem(LS.pin,  p.pin);

      msg.innerHTML = `<span class="ok">저장됨</span> • ${new Date().toLocaleString('ko-KR')} • ${p.name} • ${p.score.toLocaleString('ko-KR')}점`;
      f.score.value = '';
      f.phone.value = '';
      $('#name').focus();
    }catch(err){
      msg.innerHTML = `<span class="err">전송 실패</span> • ${err.message}`;
    }
  });

  // Enter로도 전송
  ['#name','#phone','#score','#pin'].forEach(sel=>{
    $(sel).addEventListener('keydown', ev => {
      if(ev.key === 'Enter') $('#scoreForm').requestSubmit();
    });
  });
</script>
</body>
</html>
